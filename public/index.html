<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatApp - Modern Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#3b82f6',
              'primary-dark': '#2563eb',
              'primary-light': '#60a5fa',
            },
            borderRadius: {
              '2xl': '1rem',
              '3xl': '1.5rem',
              '4xl': '2rem',
            },
          },
        },
      };
    </script>
    <style>
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .glass-effect {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.1);
      }
      .online-indicator {
        position: relative;
        z-index: 10;
      }
      .online-indicator::after {
        content: '';
        position: absolute;
        bottom: 4px;
        right: 4px;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        z-index: 100;
        pointer-events: none;
      }
      .online-indicator img {
        position: relative;
        z-index: 0;
        display: block;
      }
      .offline-indicator::after {
        display: none;
      }
    </style>
  </head>
  <body class="h-full bg-gray-50" x-data="chatApp()">
    <!-- Debug Bar (shows socket status) -->
    <div class="fixed top-4 right-4 z-50">
      <div
        class="bg-white/90 border rounded-xl p-3 shadow-lg text-xs text-gray-700"
      >
        <div class="mb-1">
          <strong>WS:</strong> <span x-text="socketStatus"></span>
        </div>
        <div class="mb-1">
          <strong>Last Ack:</strong> <span x-text="lastAckText"></span>
        </div>
        <div>
          <strong>Last Msg:</strong> <span x-text="lastReceivedText"></span>
        </div>
      </div>
    </div>
    <!-- Login/Register Pages -->
    <div
      x-show="currentView === 'login'"
      class="min-h-screen bg-primary flex items-center justify-center px-4"
    >
      <div class="max-w-md w-full">
        <div
          class="glass-effect rounded-4xl p-8 shadow-2xl border border-white/20"
        >
          <div class="text-center">
            <div
              class="mx-auto h-20 w-20 bg-white rounded-full flex items-center justify-center mb-6 shadow-lg"
            >
              <svg
                class="h-10 w-10 text-primary"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M8.5 12l1.5 1.5L14.5 9M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"
                />
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">Welcome Back</h2>
            <p class="text-white/80 mb-8">Sign in to continue chatting</p>
          </div>

          <form class="space-y-6" @submit.prevent="login">
            <div class="space-y-4">
              <div>
                <input
                  x-model="loginForm.username"
                  type="text"
                  required
                  class="w-full px-6 py-4 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200 text-lg"
                  placeholder="Username"
                />
              </div>
              <div>
                <input
                  x-model="loginForm.password"
                  type="password"
                  required
                  class="w-full px-6 py-4 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200 text-lg"
                  placeholder="Password"
                />
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-white text-primary py-4 px-6 rounded-2xl hover:bg-gray-50 focus:ring-4 focus:ring-white/50 transition-all duration-200 font-semibold text-lg"
            >
              Sign In
            </button>

            <div class="text-center">
              <button
                type="button"
                @click="currentView = 'register'"
                class="text-white/80 hover:text-white transition-colors"
              >
                Don't have an account? Sign up
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Register Page -->
    <div
      x-show="currentView === 'register'"
      class="min-h-screen bg-primary flex items-center justify-center px-4"
    >
      <div class="max-w-md w-full">
        <div
          class="glass-effect rounded-4xl p-8 shadow-2xl border border-white/20"
        >
          <div class="text-center">
            <div
              class="mx-auto h-20 w-20 bg-white rounded-full flex items-center justify-center mb-6 shadow-lg"
            >
              <svg
                class="h-10 w-10 text-primary"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M8.5 12l1.5 1.5L14.5 9M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"
                />
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">Create Account</h2>
            <p class="text-white/80 mb-8">Join and start messaging</p>
          </div>

          <form class="space-y-6" @submit.prevent="register">
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <input
                  x-model="registerForm.firstName"
                  type="text"
                  required
                  class="px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200"
                  placeholder="First name"
                />
                <input
                  x-model="registerForm.lastName"
                  type="text"
                  required
                  class="px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200"
                  placeholder="Last name"
                />
              </div>
              <div>
                <input
                  x-model="registerForm.username"
                  type="text"
                  required
                  class="w-full px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200"
                  placeholder="Username"
                />
              </div>
              <div>
                <input
                  x-model="registerForm.password"
                  type="password"
                  required
                  class="w-full px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200"
                  placeholder="Password"
                />
              </div>
              <div>
                <input
                  x-model="registerForm.confirmPassword"
                  type="password"
                  required
                  class="w-full px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200"
                  placeholder="Confirm password"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-white/80 mb-2"
                  >About you</label
                >
                <textarea
                  x-model="registerForm.description"
                  class="w-full px-4 py-3 border-0 rounded-2xl focus:ring-4 focus:ring-white/50 focus:outline-none transition-all duration-200 resize-none"
                  rows="3"
                  placeholder="Tell us something about yourself (optional)"
                ></textarea>
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-white text-primary py-4 px-6 rounded-2xl hover:bg-gray-50 focus:ring-4 focus:ring-white/50 transition-all duration-200 font-semibold"
            >
              Create Account
            </button>

            <div class="text-center">
              <button
                type="button"
                @click="currentView = 'login'"
                class="text-white/80 hover:text-white transition-colors"
              >
                Already have an account? Sign in
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Main Chat Interface -->
    <div
      x-show="currentView === 'chat'"
      class="h-screen flex bg-gray-50 overflow-hidden"
    >
      <!-- Sidebar -->
      <div
        class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col"
        x-show="!selectedChat || window.innerWidth >= 768"
      >
        <!-- Header -->
        <div
          class="p-6 border-b border-gray-200 bg-primary text-white flex-shrink-0"
        >
          <div class="flex items-center justify-between">
            <div
              class="flex items-center space-x-4 cursor-pointer"
              @click="showProfileModal = true"
            >
              <div
                class="h-12 w-12 bg-white rounded-full flex items-center justify-center online-indicator"
              >
                <template x-if="user.avatarUrl">
                  <img
                    :src="user.avatarUrl"
                    class="h-12 w-12 rounded-full object-cover"
                  />
                </template>
                <template x-if="!user.avatarUrl">
                  <span
                    class="text-primary font-semibold text-lg"
                    x-text="(user.firstName || '').charAt(0)"
                  ></span>
                </template>
              </div>
              <div>
                <h2
                  class="font-semibold text-lg"
                  x-text="user.firstName + ' ' + user.lastName"
                ></h2>
                <p class="text-xs text-blue-100">
                  @<span x-text="user.username"></span>
                </p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button
                @click="showNewChatModal = true"
                class="p-3 hover:bg-white/10 rounded-2xl transition-all duration-200"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  />
                </svg>
              </button>
              <button
                @click="logout"
                class="p-3 hover:bg-white/10 rounded-2xl transition-all duration-200"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Search -->
        <div class="p-6 border-b border-gray-100 flex-shrink-0">
          <div class="relative">
            <input
              x-model="searchQuery"
              type="text"
              class="w-full pl-12 pr-4 py-3 bg-gray-100 rounded-2xl focus:outline-none focus:ring-4 focus:ring-primary/20 focus:bg-white transition-all duration-200"
              placeholder="Search conversations"
            />
            <svg
              class="absolute left-4 top-3.5 h-5 w-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto scrollbar-hide">
          <template x-for="chat in filteredChats" :key="chat.id">
            <div
              @click="selectChat(chat)"
              @dblclick.stop="selectedChat?.id === chat.id ? (selectedChat = null) : selectChat(chat)"
              class="flex items-center p-4 hover:bg-gray-50 cursor-pointer transition-all duration-200"
              :class="{'bg-primary/5 border-r-4 border-primary': selectedChat?.id === chat.id}"
            >
              <div
                class="h-14 w-14 rounded-full flex-shrink-0 flex items-center justify-center relative overflow-hidden"
                :class="[chat.isOnline ? 'bg-primary online-indicator' : 'bg-gray-400 offline-indicator']"
              >
                <img
                  x-show="chat.avatarUrl"
                  :src="chat.avatarUrl"
                  alt="avatar"
                  class="h-full w-full object-cover"
                />
                <span
                  x-show="!chat.avatarUrl"
                  class="text-white font-semibold text-lg"
                  x-text="chat.name.charAt(0)"
                ></span>
              </div>
              <div class="ml-4 flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                  <h3
                    class="font-semibold text-gray-900 truncate"
                    x-text="chat.name"
                  ></h3>
                  <span
                    class="text-xs text-gray-500"
                    x-text="formatTime(chat.lastMessage?.timestamp)"
                  ></span>
                </div>
                <p
                  class="text-sm text-gray-600 truncate"
                  x-text="chat.lastMessage?.content || 'No messages yet'"
                ></p>
              </div>
              <div class="flex items-center space-x-2">
                <div
                  x-show="chat.unreadCount > 0"
                  class="ml-3 bg-primary text-white text-xs rounded-full h-6 w-6 flex items-center justify-center font-medium"
                >
                  <span x-text="chat.unreadCount"></span>
                </div>
                <button
                  @click.stop="deleteChat(chat)"
                  class="p-2 text-gray-400 hover:text-red-600 rounded-full"
                  title="Delete chat"
                >
                  <svg
                    class="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Chat Area -->
      <div
        class="flex-1 flex flex-col overflow-hidden"
        x-show="selectedChat || window.innerWidth >= 768"
      >
        <div
          x-show="!selectedChat"
          class="flex-1 flex items-center justify-center bg-gray-50"
        >
          <div class="text-center text-gray-500">
            <div
              class="mx-auto h-24 w-24 bg-gray-200 rounded-full flex items-center justify-center mb-6"
            >
              <svg
                class="h-12 w-12 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                />
              </svg>
            </div>
            <h3 class="text-xl font-medium mb-2">
              Select a chat to start messaging
            </h3>
            <p class="text-gray-400">
              Choose a conversation from the sidebar to begin
            </p>
          </div>
        </div>

        <div x-show="selectedChat" class="flex-1 flex flex-col overflow-hidden">
          <!-- Chat Header -->
          <div
            class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button
                  @click="selectedChat = null"
                  class="md:hidden p-2 hover:bg-gray-100 rounded-2xl"
                >
                  <svg
                    class="h-5 w-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 19l-7-7 7-7"
                    />
                  </svg>
                </button>
                <div
                  class="h-12 w-12 rounded-full flex-shrink-0 flex items-center justify-center cursor-pointer relative"
                  :class="[selectedChat?.isOnline ? 'bg-primary online-indicator' : 'bg-gray-400 offline-indicator']"
                  @click="showUserInfo = true"
                >
                  <img
                    x-show="selectedChat?.avatarUrl"
                    :src="selectedChat?.avatarUrl"
                    alt="avatar"
                    class="h-full w-full object-cover rounded-full"
                  />
                  <span
                    x-show="!selectedChat?.avatarUrl"
                    class="text-white font-semibold text-lg"
                    x-text="selectedChat?.name.charAt(0)"
                  ></span>
                </div>
                <div class="cursor-pointer" @click="showUserInfo = true">
                  <h3
                    class="font-semibold text-gray-900 text-lg"
                    x-text="selectedChat?.name"
                  ></h3>
                  <p
                    class="text-sm"
                    :class="selectedChat?.isOnline ? 'text-green-500' : 'text-gray-500'"
                    x-text="selectedChat?.isOnline ? 'Online' : 'Offline'"
                  ></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Messages -->
          <div
            class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide bg-gray-50"
            x-ref="messagesContainer"
          >
            <template
              x-for="message in selectedChat?.messages || []"
              :key="message.id"
            >
              <div
                class="flex"
                :class="message.sent ? 'justify-end' : 'justify-start'"
              >
                <div
                  class="max-w-xs lg:max-w-md px-4 py-3 rounded-3xl shadow-sm"
                  :class="message.sent ? 'bg-primary text-white' : 'bg-white text-gray-800 border border-gray-200'"
                >
                  <p x-text="message.content" class="leading-relaxed"></p>
                  <div class="flex items-center justify-end mt-2 space-x-1">
                    <span
                      class="text-xs opacity-70"
                      x-text="formatTime(message.timestamp)"
                    ></span>
                    <div x-show="message.sent" class="flex space-x-1">
                      <svg
                        x-show="message.status === 'sent'"
                        class="h-3 w-3 opacity-70"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      <svg
                        x-show="message.status === 'delivered'"
                        class="h-3 w-3 opacity-70"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      <svg
                        x-show="message.status === 'read'"
                        class="h-3 w-3 text-blue-200"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Message Input -->
          <div class="bg-white border-t border-gray-200 p-6 flex-shrink-0">
            <form
              @submit.prevent="sendMessage"
              class="flex items-end space-x-4"
            >
              <div class="flex-1">
                <textarea
                  x-ref="messageInput"
                  x-model="newMessage"
                  class="w-full px-4 py-3 bg-gray-100 rounded-3xl focus:outline-none focus:ring-4 focus:ring-primary/20 focus:bg-white transition-all duration-200 resize-none"
                  placeholder="Write a message..."
                  rows="1"
                  @input="autoResize($event)"
                  @keydown.enter.prevent="if (!$event.shiftKey) { sendMessage() }"
                  style="min-height: 48px; max-height: 120px"
                ></textarea>
              </div>
              <button
                type="submit"
                class="p-3 bg-primary text-white rounded-full hover:bg-primary-dark focus:ring-4 focus:ring-primary/20 transition-all duration-200 flex-shrink-0"
                :disabled="!newMessage.trim()"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                  />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Edit Modal -->
    <div
      x-show="showProfileModal"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.away="showProfileModal = false"
    >
      <div
        class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
      >
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        ></div>

        <div
          class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
        >
          <div class="bg-white px-6 py-6">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-xl font-semibold text-gray-900">Edit Profile</h3>
              <button
                @click="showProfileModal = false"
                class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-2xl transition-all duration-200"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div class="text-center mb-8">
              <div
                class="h-24 w-24 mx-auto bg-primary rounded-full flex items-center justify-center mb-4 online-indicator"
              >
                <template x-if="user.avatarUrl">
                  <img
                    :src="user.avatarUrl"
                    class="h-24 w-24 rounded-full object-cover"
                  />
                </template>
                <template x-if="!user.avatarUrl">
                  <span
                    class="text-white text-3xl font-semibold"
                    x-text="(user.firstName || '').charAt(0)"
                  ></span>
                </template>
              </div>
              <button
                type="button"
                class="text-primary hover:text-primary-dark font-medium cursor-pointer"
                @click.prevent="$refs.avatarInput && $refs.avatarInput.click()"
              >
                Change Picture
              </button>
              <input
                type="file"
                accept="image/*"
                @change="onFileChange"
                x-ref="avatarInput"
                class="sr-only"
              />
            </div>

            <form @submit.prevent="updateProfile" class="space-y-6">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >First Name</label
                  >
                  <input
                    x-model="editProfile.firstName"
                    type="text"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-200"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Last Name</label
                  >
                  <input
                    x-model="editProfile.lastName"
                    type="text"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-200"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Username</label
                >
                <input
                  x-model="editProfile.username"
                  type="text"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-200"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Description</label
                >
                <textarea
                  x-model="editProfile.description"
                  class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-200 resize-none"
                  rows="3"
                  placeholder="Tell us about yourself..."
                ></textarea>
              </div>

              <div class="flex space-x-4 pt-4">
                <button
                  type="button"
                  @click="showProfileModal = false"
                  class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-all duration-200"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="flex-1 px-6 py-3 bg-primary text-white rounded-2xl hover:bg-primary-dark transition-all duration-200"
                >
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- User Info Modal -->
    <div
      x-show="showUserInfo"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.away="showUserInfo = false"
    >
      <div
        class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
      >
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        ></div>

        <div
          class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
        >
          <div class="bg-white px-6 py-6">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-xl font-semibold text-gray-900">User Info</h3>
              <button
                @click="showUserInfo = false"
                class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-2xl transition-all duration-200"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div class="text-center mb-8">
              <div
                class="h-24 w-24 mx-auto rounded-full flex items-center justify-center mb-4 relative"
                :class="[selectedChat?.isOnline ? 'bg-primary online-indicator' : 'bg-gray-400 offline-indicator']"
              >
                <template x-if="selectedChat?.avatarUrl">
                  <img
                    :src="selectedChat.avatarUrl"
                    class="h-24 w-24 rounded-full object-cover"
                  />
                </template>
                <template x-if="!selectedChat?.avatarUrl">
                  <span
                    class="text-white text-3xl font-semibold"
                    x-text="selectedChat?.name.charAt(0)"
                  ></span>
                </template>
              </div>
              <h2
                class="text-2xl font-semibold text-gray-900"
                x-text="selectedChat?.name"
              ></h2>
              <p
                class="text-lg mt-1"
                :class="selectedChat?.isOnline ? 'text-green-500' : 'text-gray-500'"
                x-text="selectedChat?.isOnline ? 'Online' : 'Offline'"
              ></p>
            </div>

            <div class="space-y-3">
              <div
                class="flex items-center space-x-4 p-4 hover:bg-gray-50 rounded-2xl cursor-pointer transition-all duration-200"
              >
                <div
                  class="h-12 w-12 bg-gray-100 rounded-2xl flex items-center justify-center"
                >
                  <svg
                    class="h-6 w-6 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                    />
                  </svg>
                </div>
                <span class="text-gray-700 font-medium">Block User</span>
              </div>

              <div
                class="flex items-center space-x-4 p-4 hover:bg-gray-50 rounded-2xl cursor-pointer transition-all duration-200 text-red-600"
              >
                <div
                  class="h-12 w-12 bg-red-50 rounded-2xl flex items-center justify-center"
                >
                  <svg
                    class="h-6 w-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                </div>
                <span class="font-medium">Delete Chat</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New Chat Modal -->
    <div
      x-show="showNewChatModal"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.away="showNewChatModal = false"
    >
      <div
        class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
      >
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        ></div>

        <div
          class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
        >
          <div class="bg-white px-6 py-6">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-xl font-semibold text-gray-900">New Chat</h3>
              <button
                @click="showNewChatModal = false"
                class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-2xl transition-all duration-200"
              >
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div class="mb-6 flex space-x-2">
              <input
                x-model="newChatSearch"
                @keydown.enter.prevent="searchUser()"
                type="text"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-primary/20 focus:border-primary transition-all duration-200"
                placeholder="Search users..."
              />
              <button
                @click="searchUser"
                class="px-4 py-3 bg-primary text-white rounded-2xl"
              >
                Find
              </button>
              <button @click="clearSearch" class="px-4 py-3 border rounded-2xl">
                Clear
              </button>
            </div>

            <div class="space-y-2 max-h-80 overflow-y-auto scrollbar-hide">
              <template x-for="user in displayedAvailableUsers" :key="user.id">
                <div
                  @click="startNewChat(user)"
                  class="flex items-center space-x-4 p-4 hover:bg-gray-50 rounded-2xl cursor-pointer transition-all duration-200"
                  :class="typeof user.id === 'number' ? 'opacity-50' : ''"
                >
                  <div
                    class="h-12 w-12 rounded-full flex-shrink-0 flex items-center justify-center relative"
                  >
                    <template x-if="user.avatarUrl">
                      <img
                        :src="user.avatarUrl"
                        class="h-12 w-12 rounded-full object-cover"
                      />
                    </template>
                    <template x-if="!user.avatarUrl">
                      <div
                        :class="[user.isOnline ? 'bg-primary online-indicator' : 'bg-gray-400 offline-indicator']"
                        class="h-12 w-12 rounded-full flex items-center justify-center"
                      >
                        <span
                          class="text-white font-semibold"
                          x-text="user.name.charAt(0)"
                        ></span>
                      </div>
                    </template>
                  </div>
                  <div class="flex-1">
                    <h4
                      class="font-medium text-gray-900"
                      x-text="user.name"
                    ></h4>
                    <p class="text-sm text-gray-500">
                      <span x-text="user.username"></span>
                      <span
                        x-text="user.description ? ' — ' + user.description : ''"
                      ></span>
                    </p>
                    <div
                      x-show="typeof user.id === 'number'"
                      class="text-xs text-orange-500 mt-1"
                    >
                      Demo user - search for real users above
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alpine.js Data -->
    <script>
      function chatApp() {
        return {
          currentView: 'login', // 'login', 'register', 'chat'
          user: {
            id: null,
            firstName: '',
            lastName: '',
            username: '',
            description: '',
            avatarUrl: null,
          },
          loginForm: {
            username: '',
            password: '',
          },
          registerForm: {
            firstName: '',
            lastName: '',
            username: '',
            password: '',
            confirmPassword: '',
            description: '',
          },
          editProfile: {
            firstName: '',
            lastName: '',
            username: '',
            description: '',
            avatarUrl: '',
          },
          chats: [
            {
              id: 1,
              name: 'Alice Johnson',
              isOnline: true,
              unreadCount: 2,
              lastMessage: {
                content: 'Hey! How are you doing?',
                timestamp: new Date(Date.now() - 5 * 60000), // 5 minutes ago
              },
              messages: [
                {
                  id: 1,
                  content: 'Hello there!',
                  sent: false,
                  timestamp: new Date(Date.now() - 30 * 60000),
                  status: 'read',
                },
                {
                  id: 2,
                  content: 'Hi Alice! How are you?',
                  sent: true,
                  timestamp: new Date(Date.now() - 25 * 60000),
                  status: 'read',
                },
                {
                  id: 3,
                  content:
                    "I'm doing great! Just finished working on a new project. It's been really exciting to see everything come together.",
                  sent: false,
                  timestamp: new Date(Date.now() - 20 * 60000),
                  status: 'read',
                },
                {
                  id: 4,
                  content:
                    "That's awesome! What kind of project? I'd love to hear more about it.",
                  sent: true,
                  timestamp: new Date(Date.now() - 15 * 60000),
                  status: 'read',
                },
                {
                  id: 5,
                  content:
                    "A new chat application with modern UI design. We've been focusing on making it really user-friendly and responsive.",
                  sent: false,
                  timestamp: new Date(Date.now() - 10 * 60000),
                  status: 'read',
                },
                {
                  id: 6,
                  content: 'Hey! How are you doing?',
                  sent: false,
                  timestamp: new Date(Date.now() - 5 * 60000),
                  status: 'delivered',
                },
              ],
            },
            {
              id: 2,
              name: 'Bob Wilson',
              isOnline: false,
              unreadCount: 0,
              lastMessage: {
                content: 'Thanks for the help!',
                timestamp: new Date(Date.now() - 2 * 60 * 60000), // 2 hours ago
              },
              messages: [
                {
                  id: 1,
                  content:
                    "Can you help me with the backend setup? I'm having some issues with the database configuration.",
                  sent: false,
                  timestamp: new Date(Date.now() - 3 * 60 * 60000),
                  status: 'read',
                },
                {
                  id: 2,
                  content:
                    'Sure! What specific issues are you running into? I can walk you through the setup process.',
                  sent: true,
                  timestamp: new Date(Date.now() - 2.5 * 60 * 60000),
                  status: 'read',
                },
                {
                  id: 3,
                  content: 'Thanks for the help!',
                  sent: false,
                  timestamp: new Date(Date.now() - 2 * 60 * 60000),
                  status: 'read',
                },
              ],
            },
            {
              id: 3,
              name: 'Sarah Davis',
              isOnline: true,
              unreadCount: 5,
              lastMessage: {
                content: 'Can we schedule a meeting tomorrow?',
                timestamp: new Date(Date.now() - 30 * 60000), // 30 minutes ago
              },
              messages: [
                {
                  id: 1,
                  content:
                    "Good morning! Hope you're having a great day so far.",
                  sent: false,
                  timestamp: new Date(Date.now() - 60 * 60000),
                  status: 'read',
                },
                {
                  id: 2,
                  content:
                    "Morning Sarah! Yes, it's been productive. How about you?",
                  sent: true,
                  timestamp: new Date(Date.now() - 55 * 60000),
                  status: 'read',
                },
                {
                  id: 3,
                  content: 'Can we schedule a meeting tomorrow?',
                  sent: false,
                  timestamp: new Date(Date.now() - 30 * 60000),
                  status: 'delivered',
                },
              ],
            },
            {
              id: 4,
              name: 'Mike Thompson',
              isOnline: false,
              unreadCount: 0,
              lastMessage: {
                content: 'See you later!',
                timestamp: new Date(Date.now() - 24 * 60 * 60000), // 1 day ago
              },
              messages: [
                {
                  id: 1,
                  content:
                    "Let's catch up soon, it's been too long since we last talked.",
                  sent: false,
                  timestamp: new Date(Date.now() - 25 * 60 * 60000),
                  status: 'read',
                },
                {
                  id: 2,
                  content:
                    "Absolutely! Let me know when you're free this week.",
                  sent: true,
                  timestamp: new Date(Date.now() - 24.5 * 60 * 60000),
                  status: 'read',
                },
                {
                  id: 3,
                  content: 'See you later!',
                  sent: false,
                  timestamp: new Date(Date.now() - 24 * 60 * 60000),
                  status: 'read',
                },
              ],
            },
          ],
          selectedChat: null,
          newMessage: '',
          searchQuery: '',
          showUserInfo: false,
          showNewChatModal: false,
          showProfileModal: false,
          newChatSearch: '',
          searchResults: [],
          availableUsers: [
            { id: 5, name: 'Emma Brown', isOnline: true },
            { id: 6, name: 'James Miller', isOnline: false },
            { id: 7, name: 'Lisa Garcia', isOnline: true },
            { id: 8, name: 'Tom Anderson', isOnline: false },
            { id: 9, name: 'Sophie Wilson', isOnline: true },
            { id: 10, name: 'David Chen', isOnline: false },
          ],

          get filteredChats() {
            return this.chats.filter((chat) =>
              chat.name.toLowerCase().includes(this.searchQuery.toLowerCase()),
            );
          },

          // --- API helpers ---
          apiBase: '/api',
          async apiUpload(path, formData, opts = {}) {
            const token = this.getToken();
            const headers = opts.headers || {};
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(this.apiBase + path, {
              method: opts.method || 'POST',
              body: formData,
              headers,
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || res.statusText);
            }
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) return res.json();
            return null;
          },
          setToken(token) {
            try {
              localStorage.setItem('token', token);
            } catch (e) {}
          },
          getToken() {
            try {
              return localStorage.getItem('token');
            } catch (e) {
              return null;
            }
          },
          clearToken() {
            try {
              localStorage.removeItem('token');
            } catch (e) {}
          },
          async apiFetch(path, opts = {}) {
            const headers = opts.headers || {};
            headers['Content-Type'] = 'application/json';
            const token = this.getToken();
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(this.apiBase + path, {
              ...opts,
              headers,
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || res.statusText);
            }
            // attempt parse JSON, if no content return null
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) return res.json();
            return null;
          },

          async login() {
            if (!this.loginForm.username || !this.loginForm.password) return;
            try {
              const payload = {
                username: this.loginForm.username,
                password: this.loginForm.password,
              };
              const data = await this.apiFetch('/auth/login', {
                method: 'POST',
                body: JSON.stringify(payload),
              });
              const token = data?.access_token || data;
              if (!token) throw new Error('No token received');
              this.setToken(token);
              await this.loadProfileAndEnter();
              this.loginForm = { username: '', password: '' };
              this.connectSocket();
              await this.loadChats();
            } catch (err) {
              alert('Login failed: ' + (err.message || err));
            }
          },

          async register() {
            if (
              this.registerForm.password !== this.registerForm.confirmPassword
            ) {
              alert('Passwords do not match!');
              return;
            }
            try {
              const payload = {
                username: this.registerForm.username,
                password: this.registerForm.password,
                name: this.registerForm.firstName || undefined,
                surname: this.registerForm.lastName || undefined,
                description: this.registerForm.description || undefined,
              };
              const data = await this.apiFetch('/auth/register', {
                method: 'POST',
                body: JSON.stringify(payload),
              });
              const token = data?.access_token || data;
              if (!token) throw new Error('No token received');
              this.setToken(token);
              await this.loadProfileAndEnter();
              this.registerForm = {
                firstName: '',
                lastName: '',
                username: '',
                password: '',
                confirmPassword: '',
                description: '',
              };
              this.connectSocket();
              await this.loadChats();
            } catch (err) {
              alert('Register failed: ' + (err.message || err));
            }
          },

          async updateProfile() {
            // Persist profile changes to backend
            try {
              const payload = {
                name: this.editProfile.firstName || undefined,
                surname: this.editProfile.lastName || undefined,
                description: this.editProfile.description || undefined,
                avatarUrl: this.editProfile.avatarUrl || undefined,
                username: this.editProfile.username || undefined,
              };
              await this.apiFetch(`/users/${this.user.id}`, {
                method: 'PUT',
                body: JSON.stringify(payload),
              });
              // update local model
              this.user = { ...this.user, ...this.editProfile };
              this.showProfileModal = false;
            } catch (err) {
              alert('Failed to update profile: ' + (err.message || err));
            }
          },

          async onFileChange(e) {
            const input = e.target;
            const file = input.files && input.files[0];
            if (!file) return;
            if (!this.user || !this.user.id) {
              alert('You must be logged in to upload an avatar');
              return;
            }
            try {
              const fd = new FormData();
              fd.append('avatar', file);
              const res = await this.apiUpload(
                `/users/${this.user.id}/avatar`,
                fd,
                { method: 'POST' },
              );
              const avatarUrl = res?.avatarUrl || res;
              if (avatarUrl) {
                this.user.avatarUrl = avatarUrl;
                this.editProfile.avatarUrl = avatarUrl;
                // clear the file input
                if (this.$refs.avatarInput) this.$refs.avatarInput.value = null;
              }
            } catch (err) {
              alert('Avatar upload failed: ' + (err.message || err));
            }
          },

          async logout() {
            this.clearToken();
            this.user = {};
            this.selectedChat = null;
            this.currentView = 'login';
          },

          async loadChats() {
            try {
              const list = await this.apiFetch('/chats');
              // Backend now returns properly shaped responses, so we can use them directly
              this.chats = (list || []).map((chat) => ({
                id: chat.id,
                name: chat.name,
                participantId: chat.participantId,
                isOnline: chat.isOnline,
                unreadCount: chat.unreadCount || 0,
                lastMessage: chat.lastMessage
                  ? {
                      content: chat.lastMessage.content,
                      timestamp: new Date(chat.lastMessage.timestamp),
                    }
                  : null,
                messages: chat.messages || [],
                avatarUrl: chat.avatarUrl,
                _loaded: chat._loaded || false,
                participants: chat.participants, // Keep for backward compatibility
              }));

              // If currently selected chat exists in the newly loaded list, update selectedChat
              if (this.selectedChat && this.selectedChat.id) {
                const authoritative = this.chats.find(
                  (c) => String(c.id) === String(this.selectedChat.id),
                );
                if (authoritative) {
                  this.selectedChat = authoritative;
                }
              }
            } catch (e) {
              console.error('Failed to load chats:', e);
            }
          },

          selectChat(chat) {
            this.selectedChat = chat;
            chat.unreadCount = 0;
            if (this.socket && chat?.id) {
              this.socket.emit('join_chat', { chatId: chat.id });
            }
            if (!chat._loaded && chat.id) {
              this.apiFetch(`/chats/${chat.id}/messages`).then((msgs) => {
                try {
                  const serverMsgs = (msgs || []).map((m) => ({
                    id: m.id,
                    content: m.content,
                    sent: m.senderId === this.user.id,
                    timestamp: new Date(m.createdAt),
                    status: 'sent',
                  }));

                  // Preserve optimistic messages (tmp-...) and merge them with server messages
                  chat.messages = chat.messages || [];
                  const optimistic = chat.messages.filter((m) =>
                    String(m.id).startsWith('tmp-'),
                  );

                  // Replace any optimistic messages that the server already returned
                  const merged = serverMsgs.slice();
                  optimistic.forEach((opt) => {
                    const matchIdx = merged.findIndex((sm) => {
                      if (!sm) return false;
                      if (sm.id === opt.id) return true;
                      if (
                        sm.content === opt.content &&
                        Math.abs(
                          new Date(sm.timestamp).getTime() -
                            new Date(opt.timestamp).getTime(),
                        ) < 5000
                      ) {
                        return true;
                      }
                      return false;
                    });
                    if (matchIdx === -1) merged.push(opt);
                  });

                  chat.messages = merged;
                  chat._loaded = true;
                  this.scrollToBottom();
                } catch (e) {
                  console.error('Error loading messages for chat:', e);
                }
              });
            } else {
              this.scrollToBottom();
            }
          },

          sendMessage() {
            const content = (this.newMessage || '').trim();
            if (!content || !this.selectedChat || !this.socket) return;
            const optimistic = {
              id: `tmp-${Date.now()}`,
              content,
              sent: true,
              timestamp: new Date(),
              status: 'sending',
            };
            this.selectedChat.messages.push(optimistic);
            this.selectedChat.lastMessage = {
              content: optimistic.content,
              timestamp: optimistic.timestamp,
            };
            this.newMessage = '';
            this.scrollToBottom();
            this.socket.emit(
              'send_message',
              { chatId: this.selectedChat.id, content },
              (ack) => {
                this.lastAckText = JSON.stringify(ack || {});
                if (!ack || ack.error) {
                  const i = this.selectedChat.messages.findIndex(
                    (m) => m.id === optimistic.id,
                  );
                  if (i !== -1) this.selectedChat.messages[i].status = 'failed';
                  alert('Failed to send message');
                } else {
                  const i = this.selectedChat.messages.findIndex(
                    (m) => m.id === optimistic.id,
                  );
                  if (i !== -1) this.selectedChat.messages[i].status = 'sent';
                }
              },
            );
          },

          get displayedAvailableUsers() {
            const list = this.searchResults.length
              ? this.searchResults
              : this.availableUsers;
            const q = (this.newChatSearch || '').toLowerCase();
            const filtered = list.filter((u) => {
              const name = (u.name || '').toLowerCase();
              const username = (u.username || '').toLowerCase();
              return name.includes(q) || username.includes(q);
            });
            return filtered;
          },

          async searchUser() {
            const q = (this.newChatSearch || '').trim();
            if (!q) return;
            try {
              const res = await this.apiFetch(
                `/users/${encodeURIComponent(q)}`,
              );
              if (res) {
                const displayName = (res.name || '').trim();
                const user = {
                  id: res.id,
                  name: displayName || res.username || '',
                  isOnline: false,
                  username: res.username,
                  avatarUrl: res.avatarUrl || null,
                  description: res.description || '',
                };
                this.searchResults = [user];
              }
            } catch (err) {
              alert('User not found: ' + (err.message || err));
              this.searchResults = [];
            }
          },

          clearSearch() {
            this.searchResults = [];
            this.newChatSearch = '';
          },

          // WebSocket connection
          socket: null,
          socketStatus: 'disconnected',
          lastAckText: '',
          lastReceivedText: '',
          connectSocket() {
            try {
              const token = this.getToken();
              if (!token) return;
              if (this.socket && this.socket.connected) return;
              this.socket = io('/ws', {
                transports: ['websocket'],
                auth: { token },
                extraHeaders: { Authorization: `Bearer ${token}` },
              });
              this.socket.on('connect', () => {
                this.socketStatus = 'connected';
              });
              this.socket.on('connect_error', (err) => {
                this.socketStatus = 'error';
                this.lastAckText = String(err?.message || err);
              });
              this.socket.on('disconnect', (reason) => {
                this.socketStatus = 'disconnected';
                this.lastAckText = String(reason || '');
              });
              this.socket.on('connected', () => {
                this.socketStatus = 'ready';
              });
              this.socket.on('user_online', (ev) => {
                try {
                  const userId = ev.userId;
                  const chatId = ev.chatId;
                  // mark matching chat as online
                  const chat = this.chats.find(
                    (c) => c.id === chatId || c.participantId === userId,
                  );
                  if (chat) chat.isOnline = true;
                } catch (e) {}
              });
              this.socket.on('user_offline', (ev) => {
                try {
                  const userId = ev.userId;
                  const chatId = ev.chatId;
                  const chat = this.chats.find(
                    (c) => c.id === chatId || c.participantId === userId,
                  );
                  if (chat) chat.isOnline = false;
                } catch (e) {}
              });
              this.socket.on('new_message', (msg) => {
                try {
                  // Normalize chat id and timestamp fields
                  const chatId =
                    msg.chatId || (msg.chat && msg.chat.id) || msg.chat_id;
                  const rawTimestamp =
                    msg.createdAt ||
                    msg.timestamp ||
                    msg.created_at ||
                    new Date();
                  const createdAt = new Date(rawTimestamp);

                  let chat = this.chats.find((c) => c.id === chatId);
                  // if chat not present, create lightweight entry
                  if (!chat) {
                    const other =
                      msg.sender &&
                      msg.sender.id &&
                      msg.sender.id !== this.user.id
                        ? msg.sender
                        : null;
                    chat = {
                      id: chatId,
                      name: (other?.name || other?.username || 'Chat').trim(),
                      isOnline: false,
                      unreadCount: 0,
                      lastMessage: null,
                      messages: [],
                      avatarUrl: other?.avatarUrl || null,
                      _loaded: true,
                    };
                    this.chats.unshift(chat);
                  }

                  const isMine =
                    (msg.senderId &&
                      String(msg.senderId) === String(this.user.id)) ||
                    (msg.sender &&
                      msg.sender.id &&
                      String(msg.sender.id) === String(this.user.id));

                  if (!isMine) chat.isOnline = true;

                  chat.messages = chat.messages || [];

                  const incomingMsg = {
                    id: msg.id,
                    content: msg.content,
                    sent: Boolean(isMine),
                    timestamp: createdAt,
                    status: msg.status || 'sent',
                  };

                  const existedBefore = chat.messages.some(
                    (m) => m && m.id === incomingMsg.id,
                  );

                  let matchIdx = -1;
                  matchIdx = chat.messages.findIndex(
                    (m) => m && m.id === incomingMsg.id,
                  );
                  if (matchIdx === -1) {
                    matchIdx = chat.messages.findIndex((m) => {
                      if (!m) return false;
                      if (
                        m.status === 'sending' &&
                        m.sent &&
                        m.content === incomingMsg.content
                      ) {
                        try {
                          const t1 = new Date(m.timestamp).getTime();
                          const t2 = new Date(incomingMsg.timestamp).getTime();
                          return Math.abs(t1 - t2) < 7000;
                        } catch (err) {
                          return true;
                        }
                      }
                      return false;
                    });
                  }

                  if (matchIdx !== -1) {
                    // replace optimistic message with authoritative server message
                    chat.messages[matchIdx] = incomingMsg;
                  } else {
                    chat.messages.push(incomingMsg);
                  }

                  // Always update lastMessage to server-provided timestamp/content
                  chat.lastMessage = {
                    content: incomingMsg.content,
                    timestamp: incomingMsg.timestamp,
                  };

                  // Update unread count: increment only for remote messages when chat isn't open
                  // and this message wasn't already present (avoid double increments from duplicate events)
                  if (
                    !incomingMsg.sent &&
                    this.selectedChat?.id !== chat.id &&
                    !existedBefore
                  ) {
                    chat.unreadCount = (chat.unreadCount || 0) + 1;
                  }

                  // If the message belongs to currently selected chat, ensure scroll and marking
                  if (this.selectedChat?.id === chat.id) {
                    this.scrollToBottom();
                  }

                  this.lastReceivedText = `${incomingMsg.id || ''} ${incomingMsg.content ? (incomingMsg.content.length > 40 ? incomingMsg.content.slice(0, 40) + '...' : incomingMsg.content) : ''}`;
                } catch (e) {
                  console.error('Error handling new_message:', e);
                }
              });
              this.socket.on('new_chat', (chatData) => {
                try {
                  // Check if chat already exists to avoid duplicates
                  const existingChat = this.chats.find(
                    (c) => c.id === chatData.id,
                  );
                  if (!existingChat) {
                    this.chats.unshift(chatData);

                    // If this chat comes with messages (first message), handle them
                    if (chatData.messages && chatData.messages.length > 0) {
                      const chat = this.chats.find((c) => c.id === chatData.id);
                      if (chat) {
                        chat.messages = chatData.messages.map((m) => ({
                          id: m.id,
                          content: m.content,
                          sent: m.senderId === this.user.id,
                          timestamp: new Date(m.timestamp),
                          status: m.status || 'sent',
                        }));
                        chat.lastMessage = chatData.lastMessage;
                        // Respect explicit unreadCount from server. Default to 1 only if undefined.
                        chat.unreadCount =
                          typeof chatData.unreadCount === 'number'
                            ? chatData.unreadCount
                            : 1;
                        chat._loaded = true; // Mark as loaded since we have the messages

                        // Scroll to bottom if this chat is currently selected
                        if (this.selectedChat?.id === chatData.id) {
                          this.scrollToBottom();
                        }
                      }
                    }
                  }
                } catch (e) {
                  console.error('Error handling new_chat event:', e);
                }
              });
              this.socket.on('chat_deleted', (data) => {
                try {
                  const chatId = data.chatId;
                  const chatIndex = this.chats.findIndex(
                    (c) => c.id === chatId,
                  );
                  if (chatIndex !== -1) {
                    this.chats.splice(chatIndex, 1);
                    // If the deleted chat was selected, clear selection
                    if (this.selectedChat?.id === chatId) {
                      this.selectedChat = null;
                    }
                  }
                } catch (e) {
                  console.error('Error handling chat_deleted event:', e);
                }
              });
            } catch (e) {}
          },

          async startNewChat(user) {
            // Check if current user is authenticated
            if (!this.user || !this.user.id) {
              alert('Please log in first');
              return;
            }

            // Check if this is a dummy user (numeric ID) - if so, don't create chat
            if (typeof user.id === 'number') {
              alert(
                'Please search for a real user first by typing their username and clicking Find',
              );
              return;
            }

            const existingChat = this.chats.find(
              (chat) =>
                String(chat.participantId) === String(user.id) ||
                chat.name === user.name,
            );

            if (existingChat) {
              this.selectChat(existingChat);
            } else {
              try {
                const created = await this.apiFetch('/chats/direct', {
                  method: 'POST',
                  body: JSON.stringify({ otherUserId: user.id }),
                });

                // Backend now returns properly shaped response, so we can use it directly
                if (created) {
                  const newChat = {
                    id: created.id,
                    name: created.name,
                    participantId: created.participantId,
                    isOnline: created.isOnline,
                    unreadCount: created.unreadCount || 0,
                    lastMessage: created.lastMessage,
                    messages: created.messages || [],
                    avatarUrl: created.avatarUrl,
                    _loaded: created._loaded || false,
                    participants: created.participants, // Keep for backward compatibility
                  };

                  // Add to chats list
                  this.chats.unshift(newChat);
                  this.selectChat(newChat);

                  // Workaround: briefly close and reopen the chat so the UI
                  // attaches optimistic messages and socket events to the
                  // authoritative chat object (simulate a double-tap).
                  try {
                    setTimeout(() => {
                      try {
                        this.selectedChat = null;
                        this.selectChat(newChat);
                      } catch (e) {}
                    }, 80);
                  } catch (e) {}
                } else {
                  throw new Error('Failed to create chat');
                }
              } catch (e) {
                console.error('Failed to create chat:', e);
                alert('Failed to create chat: ' + (e.message || e));
              }
            }
            this.showNewChatModal = false;
            this.newChatSearch = '';
            this.searchResults = [];
          },

          async deleteChat(chat) {
            if (!chat || !chat.id) return;
            if (!confirm('Delete this chat? This cannot be undone.')) return;
            try {
              await this.apiFetch(`/chats/${encodeURIComponent(chat.id)}`, {
                method: 'DELETE',
              });
              const idx = this.chats.findIndex((c) => c.id === chat.id);
              if (idx !== -1) this.chats.splice(idx, 1);
              if (this.selectedChat?.id === chat.id) {
                this.selectedChat = null;
              }
            } catch (e) {
              alert('Failed to delete chat: ' + (e.message || e));
            }
          },

          scrollToBottom() {
            this.$nextTick(() => {
              if (this.$refs.messagesContainer) {
                this.$refs.messagesContainer.scrollTop =
                  this.$refs.messagesContainer.scrollHeight;
              }
              if (
                this.$refs.messageInput &&
                typeof this.$refs.messageInput.focus === 'function'
              ) {
                this.$refs.messageInput.focus();
              }
            });
          },

          autoResize(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
          },

          formatTime(date) {
            if (!date) return '';

            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) {
              return 'now';
            } else if (minutes < 60) {
              return `${minutes}m`;
            } else if (hours < 24) {
              return `${hours}h`;
            } else if (days < 7) {
              return `${days}d`;
            } else {
              return date.toLocaleDateString();
            }
          },

          init() {
            window.addEventListener('resize', () => {
              this.$nextTick();
            });
            // Try restore session
            this.loadProfileAndEnter().catch(() => {
              // ignore - user not authenticated
            });
          },

          async loadProfileAndEnter() {
            const token = this.getToken();
            if (!token) return;
            try {
              const profile = await this.apiFetch('/auth/profile');
              // map backend user to frontend user shape
              this.user = {
                id: profile.id,
                firstName: profile.name || '',
                lastName: profile.surname || '',
                username: profile.username,
                description: profile.description || '',
                avatarUrl: profile.avatarUrl || null,
              };
              this.editProfile = {
                firstName: this.user.firstName,
                lastName: this.user.lastName,
                username: this.user.username,
                description: this.user.description,
                avatarUrl: this.user.avatarUrl,
              };
              this.currentView = 'chat';
              this.connectSocket();
              await this.loadChats();
            } catch (err) {
              this.clearToken();
              // surface a visible message for debugging
              alert('Session restore failed: ' + (err.message || err));
            }
          },
        };
      }
    </script>
  </body>
</html>
